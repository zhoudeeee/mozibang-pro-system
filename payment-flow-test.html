<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢¨å­—å¸®æ”¯ä»˜æµç¨‹å®Œæ•´æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        h2 {
            color: #007cba;
            border-bottom: 2px solid #007cba;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 10px 5px;
            background: #007cba;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #005a87;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success {
            background: #28a745;
        }
        .status-error {
            background: #dc3545;
        }
        .status-pending {
            background: #ffc107;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å¢¨å­—å¸®æ”¯ä»˜æµç¨‹å®Œæ•´æµ‹è¯•</h1>
        <p style="text-align: center; color: #666; font-size: 16px;">æµ‹è¯•æ”¯ä»˜ç³»ç»Ÿçš„å„ä¸ªç»„ä»¶å’Œå®Œæ•´æµç¨‹</p>
        
        <div class="grid">
            <!-- ç”¨æˆ·IDç®¡ç†æµ‹è¯• -->
            <div class="test-section">
                <h2>ğŸ‘¤ ç”¨æˆ·IDç®¡ç†æµ‹è¯•</h2>
                <p>æµ‹è¯•ç”¨æˆ·IDçš„ç”Ÿæˆã€å­˜å‚¨å’Œè·å–åŠŸèƒ½</p>
                
                <button class="btn" onclick="generateUserId()">ç”Ÿæˆæ–°ç”¨æˆ·ID</button>
                <button class="btn btn-warning" onclick="getUserId()">è·å–å½“å‰ç”¨æˆ·ID</button>
                <button class="btn btn-warning" onclick="clearUserId()">æ¸…é™¤ç”¨æˆ·ID</button>
                
                <div id="userIdResult" class="result info" style="display: none;"></div>
            </div>
            
            <!-- æ”¯ä»˜é¡µé¢æµ‹è¯• -->
            <div class="test-section">
                <h2>ğŸ’³ æ”¯ä»˜é¡µé¢æµ‹è¯•</h2>
                <p>æµ‹è¯•pay.htmlé¡µé¢çš„åŠŸèƒ½å’Œç”¨æˆ·IDä¼ é€’</p>
                
                <button class="btn" onclick="openPaymentPage()">æ‰“å¼€æ”¯ä»˜é¡µé¢</button>
                <button class="btn btn-success" onclick="openPaymentPageWithTestId()">ä½¿ç”¨æµ‹è¯•IDæ‰“å¼€</button>
                
                <div id="paymentResult" class="result info" style="display: none;"></div>
            </div>
            
            <!-- è®¸å¯è¯ç³»ç»Ÿæµ‹è¯• -->
            <div class="test-section">
                <h2>ğŸ” è®¸å¯è¯ç³»ç»Ÿæµ‹è¯•</h2>
                <p>æµ‹è¯•Proè®¸å¯è¯çš„éªŒè¯å’ŒçŠ¶æ€ç®¡ç†</p>
                
                <button class="btn" onclick="checkLicenseStatus()">æ£€æŸ¥è®¸å¯è¯çŠ¶æ€</button>
                <button class="btn btn-success" onclick="simulateProUpgrade()">æ¨¡æ‹ŸProå‡çº§</button>
                <button class="btn btn-warning" onclick="resetToFree()">é‡ç½®ä¸ºå…è´¹ç‰ˆ</button>
                
                <div id="licenseResult" class="result info" style="display: none;"></div>
            </div>
            
            <!-- å­˜å‚¨ç³»ç»Ÿæµ‹è¯• -->
            <div class="test-section">
                <h2>ğŸ’¾ å­˜å‚¨ç³»ç»Ÿæµ‹è¯•</h2>
                <p>æµ‹è¯•æœ¬åœ°å­˜å‚¨å’Œæ•°æ®ç®¡ç†åŠŸèƒ½</p>
                
                <button class="btn" onclick="testStorage()">æµ‹è¯•å­˜å‚¨åŠŸèƒ½</button>
                <button class="btn btn-warning" onclick="clearAllStorage()">æ¸…é™¤æ‰€æœ‰å­˜å‚¨</button>
                
                <div id="storageResult" class="result info" style="display: none;"></div>
            </div>
            
            <!-- PaymentManageræµ‹è¯• -->
            <div class="test-section">
                <h2>ğŸª PaymentManageræµ‹è¯•</h2>
                <p>æµ‹è¯•å†…ç½®æ”¯ä»˜ç®¡ç†å™¨çš„å¼¹çª—åŠŸèƒ½</p>
                
                <button class="btn" onclick="testPaymentManager()">æµ‹è¯•å‡çº§å¼¹çª—</button>
                <button class="btn btn-success" onclick="testPersonalPayment()">æµ‹è¯•ä¸ªäººæ”¶æ¬¾å¼¹çª—</button>
                
                <div id="paymentManagerResult" class="result info" style="display: none;"></div>
            </div>
            
            <!-- å®Œæ•´æµç¨‹æµ‹è¯• -->
            <div class="test-section">
                <h2>ğŸ”„ å®Œæ•´æµç¨‹æµ‹è¯•</h2>
                <p>æ¨¡æ‹Ÿä»å…è´¹ç‰ˆåˆ°Proç‰ˆçš„å®Œæ•´å‡çº§æµç¨‹</p>
                
                <button class="btn btn-success" onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
                <button class="btn btn-warning" onclick="resetTestEnvironment()">é‡ç½®æµ‹è¯•ç¯å¢ƒ</button>
                
                <div id="fullTestResult" class="result info" style="display: none;"></div>
            </div>
        </div>
        
        <!-- ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º -->
        <div class="test-section" style="margin-top: 30px;">
            <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
            <div id="systemStatus">
                <p><span class="status-indicator status-pending"></span>ç­‰å¾…æµ‹è¯•...</p>
            </div>
        </div>
    </div>
    
    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="mozibang-storage.js"></script>
    <script src="payment.js"></script>
    <script src="license.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let storageAdapter;
        let testResults = {};
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            try {
                storageAdapter = new MoziBangStorageAdapter();
                updateSystemStatus('åˆå§‹åŒ–å®Œæˆ', 'success');
            } catch (error) {
                updateSystemStatus('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        });
        
        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus(message, type = 'info') {
            const statusDiv = document.getElementById('systemStatus');
            const statusClass = type === 'success' ? 'status-success' : 
                              type === 'error' ? 'status-error' : 'status-pending';
            const timestamp = new Date().toLocaleTimeString();
            
            statusDiv.innerHTML = `
                <p><span class="status-indicator ${statusClass}"></span>${message}</p>
                <small style="color: #666;">æœ€åæ›´æ–°: ${timestamp}</small>
            `;
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type = 'info') {
            const resultDiv = document.getElementById(elementId);
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
        }
        
        // ç”¨æˆ·IDç®¡ç†åŠŸèƒ½
        function generateUserId() {
            try {
                if (storageAdapter) {
                    const userId = storageAdapter.generateUUID();
                    storageAdapter.setUserId(userId);
                    showResult('userIdResult', `æ–°ç”¨æˆ·IDå·²ç”Ÿæˆ: ${userId}`, 'success');
                    updateSystemStatus('ç”¨æˆ·IDç”ŸæˆæˆåŠŸ', 'success');
                } else {
                    throw new Error('å­˜å‚¨é€‚é…å™¨æœªåˆå§‹åŒ–');
                }
            } catch (error) {
                showResult('userIdResult', `ç”Ÿæˆç”¨æˆ·IDå¤±è´¥: ${error.message}`, 'error');
                updateSystemStatus('ç”¨æˆ·IDç”Ÿæˆå¤±è´¥', 'error');
            }
        }
        
        function getUserId() {
            try {
                if (storageAdapter) {
                    const userId = storageAdapter.getUserId();
                    if (userId) {
                        showResult('userIdResult', `å½“å‰ç”¨æˆ·ID: ${userId}`, 'info');
                    } else {
                        showResult('userIdResult', 'æœªæ‰¾åˆ°ç”¨æˆ·IDï¼Œè¯·å…ˆç”Ÿæˆ', 'error');
                    }
                } else {
                    throw new Error('å­˜å‚¨é€‚é…å™¨æœªåˆå§‹åŒ–');
                }
            } catch (error) {
                showResult('userIdResult', `è·å–ç”¨æˆ·IDå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function clearUserId() {
            try {
                localStorage.removeItem('mozibang_userId');
                showResult('userIdResult', 'ç”¨æˆ·IDå·²æ¸…é™¤', 'success');
                updateSystemStatus('ç”¨æˆ·IDå·²æ¸…é™¤', 'success');
            } catch (error) {
                showResult('userIdResult', `æ¸…é™¤ç”¨æˆ·IDå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ”¯ä»˜é¡µé¢åŠŸèƒ½
        function openPaymentPage() {
            try {
                const userId = storageAdapter ? storageAdapter.getUserId() : null;
                if (!userId) {
                    showResult('paymentResult', 'è¯·å…ˆç”Ÿæˆç”¨æˆ·ID', 'error');
                    return;
                }
                
                const payUrl = `pay.html?userId=${encodeURIComponent(userId)}`;
                window.open(payUrl, '_blank');
                showResult('paymentResult', `æ”¯ä»˜é¡µé¢å·²æ‰“å¼€ï¼Œç”¨æˆ·ID: ${userId}`, 'success');
                updateSystemStatus('æ”¯ä»˜é¡µé¢å·²æ‰“å¼€', 'success');
            } catch (error) {
                showResult('paymentResult', `æ‰“å¼€æ”¯ä»˜é¡µé¢å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function openPaymentPageWithTestId() {
            const testUserId = 'mozibang-test-' + Date.now();
            const payUrl = `pay.html?userId=${encodeURIComponent(testUserId)}`;
            window.open(payUrl, '_blank');
            showResult('paymentResult', `æµ‹è¯•æ”¯ä»˜é¡µé¢å·²æ‰“å¼€ï¼Œæµ‹è¯•ID: ${testUserId}`, 'success');
        }
        
        // è®¸å¯è¯ç³»ç»ŸåŠŸèƒ½
        function checkLicenseStatus() {
            try {
                const isPro = localStorage.getItem('mozibang_isPro') === 'true';
                const licenseKey = localStorage.getItem('mozibang_licenseKey');
                const expiryDate = localStorage.getItem('mozibang_licenseExpiry');
                
                let statusMessage = `ProçŠ¶æ€: ${isPro ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»'}\n`;
                if (licenseKey) {
                    statusMessage += `è®¸å¯è¯å¯†é’¥: ${licenseKey}\n`;
                }
                if (expiryDate) {
                    statusMessage += `åˆ°æœŸæ—¶é—´: ${new Date(expiryDate).toLocaleString()}`;
                }
                
                showResult('licenseResult', statusMessage, isPro ? 'success' : 'info');
                updateSystemStatus(`è®¸å¯è¯çŠ¶æ€: ${isPro ? 'Pro' : 'å…è´¹ç‰ˆ'}`, isPro ? 'success' : 'pending');
            } catch (error) {
                showResult('licenseResult', `æ£€æŸ¥è®¸å¯è¯å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function simulateProUpgrade() {
            try {
                const licenseKey = 'test-license-' + Date.now();
                const expiryDate = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000); // 1å¹´å
                
                localStorage.setItem('mozibang_isPro', 'true');
                localStorage.setItem('mozibang_licenseKey', licenseKey);
                localStorage.setItem('mozibang_licenseExpiry', expiryDate.toISOString());
                
                showResult('licenseResult', `Proå‡çº§æ¨¡æ‹ŸæˆåŠŸ!\nè®¸å¯è¯: ${licenseKey}\nåˆ°æœŸ: ${expiryDate.toLocaleString()}`, 'success');
                updateSystemStatus('å·²å‡çº§åˆ°Proç‰ˆ', 'success');
            } catch (error) {
                showResult('licenseResult', `æ¨¡æ‹Ÿå‡çº§å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function resetToFree() {
            try {
                localStorage.removeItem('mozibang_isPro');
                localStorage.removeItem('mozibang_licenseKey');
                localStorage.removeItem('mozibang_licenseExpiry');
                
                showResult('licenseResult', 'å·²é‡ç½®ä¸ºå…è´¹ç‰ˆ', 'success');
                updateSystemStatus('å·²é‡ç½®ä¸ºå…è´¹ç‰ˆ', 'success');
            } catch (error) {
                showResult('licenseResult', `é‡ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // å­˜å‚¨ç³»ç»Ÿæµ‹è¯•
        function testStorage() {
            try {
                const testData = {
                    timestamp: Date.now(),
                    testString: 'æµ‹è¯•æ•°æ®',
                    testNumber: 12345,
                    testArray: [1, 2, 3]
                };
                
                // æµ‹è¯•å­˜å‚¨
                localStorage.setItem('mozibang_test', JSON.stringify(testData));
                
                // æµ‹è¯•è¯»å–
                const retrieved = JSON.parse(localStorage.getItem('mozibang_test'));
                
                if (JSON.stringify(testData) === JSON.stringify(retrieved)) {
                    showResult('storageResult', 'å­˜å‚¨ç³»ç»Ÿæµ‹è¯•é€šè¿‡!\næ•°æ®å†™å…¥å’Œè¯»å–æ­£å¸¸', 'success');
                    updateSystemStatus('å­˜å‚¨ç³»ç»Ÿæ­£å¸¸', 'success');
                } else {
                    throw new Error('æ•°æ®ä¸åŒ¹é…');
                }
            } catch (error) {
                showResult('storageResult', `å­˜å‚¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateSystemStatus('å­˜å‚¨ç³»ç»Ÿå¼‚å¸¸', 'error');
            }
        }
        
        function clearAllStorage() {
            try {
                const keys = Object.keys(localStorage).filter(key => key.startsWith('mozibang_'));
                keys.forEach(key => localStorage.removeItem(key));
                
                showResult('storageResult', `å·²æ¸…é™¤ ${keys.length} ä¸ªå­˜å‚¨é¡¹ç›®:\n${keys.join('\n')}`, 'success');
                updateSystemStatus('å­˜å‚¨å·²æ¸…ç©º', 'success');
            } catch (error) {
                showResult('storageResult', `æ¸…é™¤å­˜å‚¨å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // PaymentManageræµ‹è¯•
        function testPaymentManager() {
            try {
                if (typeof window.PaymentManager !== 'undefined') {
                    window.PaymentManager.showUpgradeDialog();
                    showResult('paymentManagerResult', 'PaymentManagerå‡çº§å¼¹çª—å·²æ‰“å¼€', 'success');
                } else {
                    showResult('paymentManagerResult', 'PaymentManageræœªåŠ è½½ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼ˆä»…åœ¨Chromeæ‰©å±•ä¸­å¯ç”¨ï¼‰', 'info');
                }
            } catch (error) {
                showResult('paymentManagerResult', `PaymentManageræµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function testPersonalPayment() {
            try {
                if (typeof window.PaymentManager !== 'undefined') {
                    window.PaymentManager.showPersonalPaymentDialog();
                    showResult('paymentManagerResult', 'PaymentManagerä¸ªäººæ”¶æ¬¾å¼¹çª—å·²æ‰“å¼€', 'success');
                } else {
                    showResult('paymentManagerResult', 'PaymentManageræœªåŠ è½½ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼ˆä»…åœ¨Chromeæ‰©å±•ä¸­å¯ç”¨ï¼‰', 'info');
                }
            } catch (error) {
                showResult('paymentManagerResult', `ä¸ªäººæ”¶æ¬¾æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // å®Œæ•´æµç¨‹æµ‹è¯•
        function runFullTest() {
            showResult('fullTestResult', 'å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•...', 'info');
            
            let testLog = '=== å®Œæ•´æµç¨‹æµ‹è¯• ===\n';
            let allPassed = true;
            
            try {
                // 1. æ¸…ç†ç¯å¢ƒ
                testLog += '1. æ¸…ç†æµ‹è¯•ç¯å¢ƒ...\n';
                clearAllStorage();
                
                // 2. ç”Ÿæˆç”¨æˆ·ID
                testLog += '2. ç”Ÿæˆç”¨æˆ·ID...\n';
                if (storageAdapter) {
                    const userId = storageAdapter.generateUUID();
                    storageAdapter.setUserId(userId);
                    testLog += `   âœ“ ç”¨æˆ·ID: ${userId}\n`;
                } else {
                    throw new Error('å­˜å‚¨é€‚é…å™¨æœªåˆå§‹åŒ–');
                }
                
                // 3. æµ‹è¯•å­˜å‚¨
                testLog += '3. æµ‹è¯•å­˜å‚¨åŠŸèƒ½...\n';
                localStorage.setItem('mozibang_test', 'test-value');
                if (localStorage.getItem('mozibang_test') === 'test-value') {
                    testLog += '   âœ“ å­˜å‚¨åŠŸèƒ½æ­£å¸¸\n';
                } else {
                    throw new Error('å­˜å‚¨åŠŸèƒ½å¼‚å¸¸');
                }
                
                // 4. æ¨¡æ‹Ÿæ”¯ä»˜æµç¨‹
                testLog += '4. æ¨¡æ‹Ÿæ”¯ä»˜æµç¨‹...\n';
                const testLicense = 'full-test-license-' + Date.now();
                localStorage.setItem('mozibang_isPro', 'true');
                localStorage.setItem('mozibang_licenseKey', testLicense);
                testLog += `   âœ“ Proè®¸å¯è¯å·²æ¿€æ´»: ${testLicense}\n`;
                
                // 5. éªŒè¯ProçŠ¶æ€
                testLog += '5. éªŒè¯ProçŠ¶æ€...\n';
                const isPro = localStorage.getItem('mozibang_isPro') === 'true';
                if (isPro) {
                    testLog += '   âœ“ ProçŠ¶æ€éªŒè¯é€šè¿‡\n';
                } else {
                    throw new Error('ProçŠ¶æ€éªŒè¯å¤±è´¥');
                }
                
                testLog += '\n=== æµ‹è¯•å®Œæˆ ===\næ‰€æœ‰æµ‹è¯•é¡¹ç›®å‡é€šè¿‡! ğŸ‰';
                showResult('fullTestResult', testLog, 'success');
                updateSystemStatus('å®Œæ•´æµ‹è¯•é€šè¿‡', 'success');
                
            } catch (error) {
                testLog += `\nâŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                showResult('fullTestResult', testLog, 'error');
                updateSystemStatus('å®Œæ•´æµ‹è¯•å¤±è´¥', 'error');
            }
        }
        
        function resetTestEnvironment() {
            try {
                // æ¸…é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®
                clearAllStorage();
                
                // é‡ç½®æ‰€æœ‰ç»“æœæ˜¾ç¤º
                const resultDivs = document.querySelectorAll('.result');
                resultDivs.forEach(div => {
                    div.style.display = 'none';
                    div.textContent = '';
                });
                
                updateSystemStatus('æµ‹è¯•ç¯å¢ƒå·²é‡ç½®', 'success');
            } catch (error) {
                updateSystemStatus('é‡ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
